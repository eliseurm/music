<div #appContainer class="app-container"
     [class.fullscreen]="isFullscreen"
     (mousemove)="resetControlsTimer()"
     (click)="resetControlsTimer()"
     (touchstart)="resetControlsTimer()">

  <p-toast position="top-right"></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <app-toolbar
    [class.hidden]="isFullscreen"
    [zoomLevel]="zoomLevel"
    [currentKey]="currentKey"
    [showPositions]="showPositions"
    [instruments]="instruments"
    [fileName]="fileName"
    [annotationMode]="annotationMode"
    [annotationColor]="annotationColor"
    (zoomIn)="zoomIn()"
    (zoomOut)="zoomOut()"
    (toggleSidebar)="toggleSidebar()"
    (togglePositions)="togglePositions()"
    (transposeToKey)="transposeToKey($event)"
    (saveSettings)="saveSettings()"
    (toggleFullscreen)="toggleFullscreen()"
    (instrumentVisibilityChange)="onInstrumentVisibilityChange($event)"
    (setAnnotationMode)="annotationMode = $event"
    (setAnnotationColor)="annotationColor = $event"
    (clearAnnotations)="clearAnnotations()">
  </app-toolbar>

  <div class="main-content">
    <app-file-explorer
      class="sidebar"
      [class.hidden]="!sidebarVisible || isFullscreen"
      (fileSelected)="loadScoreFromFile($event)"
      (driveFileSelected)="loadScoreFromGoogleDrive($event)"
      (scoreSelected)="loadSelectedScore($event)"
      (removeScores)="onRemoveScores($event)"
      (resetScore)="onResetScore($event)"
      (orderChanged)="onOrderChanged($event)"
      [disabled]="!isOSMDReady">
    </app-file-explorer>

    <div class="score-area" [class.fullscreen]="isFullscreen">
      <div class="score-relative-container" (window:resize)="onResize()">
        <div #osmdContainer class="osmd-container"></div>
        <canvas #annotationCanvas
                class="annotation-canvas"
                [class.drawing]="annotationMode !== 'none'"
                (mousedown)="startDrawing($event)"
                (mousemove)="draw($event)"
                (mouseup)="stopDrawing()"
                (mouseleave)="stopDrawing()"
                (touchstart)="startDrawing($event)"
                (touchmove)="draw($event)"
                (touchend)="stopDrawing()">
        </canvas>

        <div *ngIf="isLoading" class="state-message loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando visualizador de partituras...</p>
        </div>

        <div *ngIf="errorMessage" class="state-message error">
          <i class="fas fa-exclamation-triangle"></i>
          <p>{{ errorMessage }}</p>
          <button class="btn-retry" (click)="initializeOSMD()">
            <i class="fas fa-redo"></i> Tentar novamente
          </button>
        </div>

        <div *ngIf="!isLoading && !errorMessage && !isOSMDReady" class="state-message info">
          <i class="fas fa-music"></i>
          <h3>Trombone Score Viewer</h3>
          <p>Inicializando visualizador de partituras...</p>
        </div>

        <div class="floating-controls"
             *ngIf="isFullscreen"
             [class.hidden-controls]="!showFloatingControls">
          <button class="float-btn" (click)="loadPreviousScore()">...</button>
        </div>

      </div>
    </div>
  </div>

  <div class="floating-controls" *ngIf="isFullscreen" [class.hidden-controls]="!showFloatingControls">
    <button class="float-btn" (click)="loadPreviousScore()" title="Partitura Anterior" *ngIf="selectedScores.length > 1">
      <i class="fas fa-chevron-left"></i>
    </button>
    <button class="float-btn" (click)="zoomOut()" title="Zoom -">
      <i class="fas fa-search-minus"></i>
    </button>
    <button class="float-btn" (click)="zoomIn()" title="Zoom +">
      <i class="fas fa-search-plus"></i>
    </button>
    <button class="float-btn" (click)="loadNextScore()" title="Próxima Partitura" *ngIf="selectedScores.length > 1">
      <i class="fas fa-chevron-right"></i>
    </button>

    <!-- Novos controles de marcação -->
    <div class="divider"></div>

    <button class="float-btn"
            [class.active]="annotationMode === 'pencil'"
            (click)="setAnnotationModeFullscreen('pencil')"
            title="Lápis">
      <i class="fas fa-pencil-alt"></i>
    </button>
    <button class="float-btn"
            [class.active]="annotationMode === 'highlighter'"
            (click)="setAnnotationModeFullscreen('highlighter')"
            title="Marca-texto">
      <i class="fas fa-highlighter"></i>
    </button>

    <div class="color-picker-wrapper">
      <input type="color"
             [ngModel]="annotationColor"
             (ngModelChange)="annotationColor = $event"
             class="float-color-picker"
             title="Cor da marcação">
    </div>

    <button class="float-btn"
            (click)="clearAnnotations()"
            title="Limpar marcações">
      <i class="fas fa-eraser"></i>
    </button>

    <div class="divider"></div>

    <button class="float-btn" (click)="exitFullscreen()" title="Sair do modo tela cheia">
      <i class="fas fa-compress"></i>
    </button>
  </div>
</div>
